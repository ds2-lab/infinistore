#!/bin/bash

PWD=`dirname $0`
PRIVATEKEY=~/.ssh/tianium              # The private key to access the remote machine. Password mode is not supported.
REMOTE="ubuntu@server.gmu.tianium.com" # Leave empty as "" to process data locally
REMOTE_HOME="~/infinistore/evaluation" # The evaluation directory on the remote machine
DATA_HOME="data"                       # The data directory on the remote machine
REMOTE_DATA=$REMOTE_HOME/$DATA_HOME
LOCAL_DATA=$PWD/$DATA_HOME
LOCAL_DEST=$PWD/downloaded/proxy/      # The local directory to store the downloaded data

FOLDER=$1
# date "+%Y%m%d%H%M" -d "$FOLDER" > /dev/null  2>&1 # Linux
date -jf "%Y%m%d%H%M" "$FOLDER" > /dev/null  2>&1  # Mac
if [ $? -ne 0 ]; then
		FOLDER=""
fi
if [ "$FOLDER" == "" ] ; then
	echo "Please specify the data directory, in the form of YYYYMMDDHHmm"
	exit 1
fi

mkdir -p $DOWNLOAD

if [ "$2" != "" ] ; then
	REMOTE=$2
fi

if [ "$REMOTE" != "" ] ; then
	echo "Downloading experiment($FOLDER) data from $REMOTE:$REMOTE_DATA to $LOCAL_DEST"
	ssh -i $PRIVATEKEY -t $REMOTE "cd $REMOTE_DATA && tar -czf $FOLDER.tar.gz $FOLDER $FOLDER*.log $FOLDER*.clog logs/$FOLDER"
	scp -i $PRIVATEKEY $REMOTE:$REMOTE_DATA/$FOLDER.tar.gz $LOCAL_DEST
else
	echo "Processing data locally. Copying experiment($FOLDER) data from $LOCAL_DATA to $LOCAL_DEST"
	cd $LOCAL_DATA && tar -czf $FOLDER.tar.gz $FOLDER $FOLDER*.log $FOLDER*.clog logs/$FOLDER
	cp $LOCAL_DATA/$FOLDER.tar.gz $LOCAL_DEST
fi
